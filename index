<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bezpeƒçn√° schr√°nka ‚Äì prototyp</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #111;
      --muted: #555;
      --primary: #ff3131;
      --primary-press: #e12828;
      --ok: #0a7f3f;
      --focus: 3px solid #3b82f6;
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--text); background: var(--bg);
      display: grid; place-items: center;
    }
    .app {
      width: min(440px, 100%);
      min-height: 100dvh;
      background: var(--bg);
    }
    header {
      padding: 16px 20px; text-align: center;
      color: var(--muted); font-size: 14px;
    }
    main { padding: 20px; }
    .card {
      background: var(--card); border-radius: var(--radius);
      padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,.06);
    }
    .big-red {
      display: block; width: 100%; padding: 22px 16px; border: 0;
      background: var(--primary); color: #fff; font-size: 22px; font-weight: 700;
      border-radius: 20px; cursor: pointer;
    }
    .big-red:active { background: var(--primary-press); }
    .row { display: grid; gap: 12px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .btn, .choice {
      background: var(--card); border: 2px solid #e8e8ef; border-radius: 14px;
      padding: 14px; text-align: center; cursor: pointer;
      font-size: 16px;
    }
    .choice strong { display: block; margin-top: 6px; }
    .btn:focus, .choice:focus, .big-red:focus, input[type="text"]:focus, textarea:focus, select:focus { outline: var(--focus); }
    .muted { color: var(--muted); font-size: 14px; }
    .actions { display: flex; gap: 10px; justify-content: space-between; margin-top: 16px; }
    .next { background: #111; color: #fff; border: 0; border-radius: 12px; padding: 14px 16px; width: 100%; font-size: 16px; }
    .ghost { background: transparent; border: 2px solid #ddd; color: #111; border-radius: 12px; padding: 12px 16px; width: 100%; font-size: 16px; }
    label { display: block; margin: 10px 0 6px; font-weight: 600; }
    input[type="text"], select, textarea {
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 2px solid #e8e8ef; background: #fff; font-size: 16px;
    }
    textarea { min-height: 120px; resize: vertical; }
    .hidden { display: none !important; }
    .status {
      display: inline-block; background: #eef7f1; color: var(--ok);
      padding: 6px 10px; border-radius: 999px; font-weight: 600; font-size: 14px;
    }
    .tts { margin-left: 6px; font-size: 15px; background: #f1f5ff; border: 0; border-radius: 999px; padding: 6px 10px; cursor: pointer; }
    .audioBox {
      border: 2px dashed #e0e0ea; border-radius: 16px; padding: 16px; text-align: center;
    }
    .audioBox button { margin: 0 6px 8px 6px; padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .small { font-size: 13px; color: var(--muted); }
    .center { text-align:center; }
  </style>
</head>
<body>
  <div class="app">
    <header>Bezpeƒçn√° schr√°nka ‚Äì <span class="muted">prototyp (offline, pouze do va≈°eho prohl√≠≈æeƒçe)</span></header>
    <main>
      <!-- SCREEN: Intro -->
      <section id="screen-intro" class="card">
        <div class="row" style="gap:16px;">
          <button class="big-red" id="startBtn">Chci nƒõco nahl√°sit</button>
          <div class="muted center">‚ÑπÔ∏è Kr√°tk√© vysvƒõtlen√≠ najde≈° v ‚ÄûJak to funguje?‚Äú (p≈ôid√°me v pln√© verzi).</div>
        </div>
      </section>

      <!-- SCREEN: Age -->
      <section id="screen-age" class="card hidden">
        <h2 style="margin-top:0;">Vyber, do kter√© t≈ô√≠dy chod√≠≈°</h2>
        <div class="grid-3">
          <button class="choice" data-age="1-3">üë∂<strong>1.‚Äì3.</strong></button>
          <button class="choice" data-age="4-6">üßí<strong>4.‚Äì6.</strong></button>
          <button class="choice" data-age="7-9">üßë<strong>7.‚Äì9.</strong></button>
        </div>
        <div class="actions">
          <button class="ghost" data-back="intro">Zpƒõt</button>
        </div>
      </section>

      <!-- SCREEN: What happened -->
      <section id="screen-what" class="card hidden">
        <div class="row">
          <div style="display:flex;align-items:center;gap:8px;">
            <h2 id="whatTitle" style="margin:0;">Co se stalo?</h2>
            <button class="tts" id="ttsWhat" title="P≈ôeƒç√≠st nahlas">üîä</button>
          </div>
          <div id="whatGrid" class="grid-2">
            <!-- buttons injected based on age -->
          </div>
          <div class="actions">
            <button class="ghost" data-back="age">Zpƒõt</button>
            <button class="next" id="toWhere" disabled>Pokraƒçovat</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Where -->
      <section id="screen-where" class="card hidden">
        <div class="row">
          <div style="display:flex;align-items:center;gap:8px;">
            <h2 id="whereTitle" style="margin:0;">Kde to bylo?</h2>
            <button class="tts" id="ttsWhere" title="P≈ôeƒç√≠st nahlas">üîä</button>
          </div>
          <div class="grid-2" id="whereGrid"></div>
          <label for="when">Kdy zhruba?</label>
          <select id="when">
            <option value="">Vyber‚Ä¶</option>
            <option value="dnes">Dnes</option>
            <option value="vcera">Vƒçera</option>
            <option value="drive">D≈ô√≠v</option>
          </select>
          <div class="actions">
            <button class="ghost" data-back="what">Zpƒõt</button>
            <button class="next" id="toPrivacy" disabled>Pokraƒçovat</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Privacy / Name / Teacher -->
      <section id="screen-privacy" class="card hidden">
        <div class="row">
          <h2 style="margin:0;">Chce≈° z≈Østat anonymn√≠?</h2>
          <div class="grid-2">
            <button class="choice" data-anon="yes">üé≠ <strong>Z≈Østat anonymnƒõ</strong></button>
            <button class="choice" data-anon="no">‚úçÔ∏è <strong>Nap√≠≈°u sv√© jm√©no</strong></button>
          </div>
          <div id="nameBox" class="hidden">
            <label for="name">Jm√©no (nepovinn√©)</label>
            <input id="name" type="text" placeholder="nap≈ô. Aneta, 6.B" autocomplete="name">
          </div>

          <label style="margin-top:12px;">Chce≈°, aby to dostal i uƒçitel, kter√©mu d≈Øvƒõ≈ôuje≈°?</label>
          <select id="teacher">
            <option value="">Ne, jen psycholog / VP</option>
          </select>

          <div class="actions">
            <button class="ghost" data-back="where">Zpƒõt</button>
            <button class="next" id="toDescribe">Pokraƒçovat</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Describe / Audio -->
      <section id="screen-describe" class="card hidden">
        <div class="row">
          <h2 style="margin:0;">Popi≈°, co se stalo</h2>
          <p class="small">M≈Ø≈æe≈° to <strong>napsat</strong> nebo <strong>namluvit</strong>. Staƒç√≠ kr√°tce.</p>
          <label for="desc">Text (nepovinn√©)</label>
          <textarea id="desc" placeholder="Nap≈ô.: Na chodbƒõ mi spolu≈æ√°k strh√°v√° ƒçepici a smƒõje se."></textarea>

          <div class="audioBox">
            <div id="aState" class="small">üé§ Hlasov√° zpr√°va (max. ~2 min)</div>
            <div style="margin-top:8px;">
              <button id="recBtn">Nahr√°t</button>
              <button id="stopBtn" disabled>Zastavit</button>
              <button id="playBtn" disabled>P≈ôehr√°t</button>
              <audio id="player" controls class="hidden"></audio>
            </div>
            <div class="small">Pozn.: v prototypu se zvuk neukl√°d√° trvale (po obnoven√≠ str√°nky zmiz√≠).</div>
          </div>

          <div class="actions">
            <button class="ghost" data-back="privacy">Zpƒõt</button>
            <button class="next" id="submitBtn">Odeslat</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Receipt -->
      <section id="screen-receipt" class="card hidden">
        <div class="row center">
          <h2>D√≠ky, ≈æe ses svƒõ≈ôil/a üíõ</h2>
          <p>Tvoje zpr√°va k n√°m dorazila. Ozveme se sem, do tv√© schr√°nky.</p>
          <div class="status">Tv≈Øj k√≥d: <span id="caseCode" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></span></div>
          <div class="actions" style="margin-top:16px;">
            <button class="next" id="copyCode">üìã Ulo≈æit k√≥d</button>
            <button class="ghost" id="gotoMailbox">Otev≈ô√≠t schr√°nku</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Mailbox -->
      <section id="screen-mailbox" class="card hidden">
        <div class="row">
          <h2>Moje schr√°nka</h2>
          <div id="mailboxContent" class="row"></div>
          <div class="actions">
            <button class="ghost" data-back="intro">Dom≈Ø</button>
          </div>
          <p class="small muted">Pozn.: V t√©to uk√°zce odpovƒõdi ≈°koly simulujeme ‚Äì v re√°ln√© aplikaci je p√≠≈°e psycholog.</p>
          <div class="actions">
            <button class="btn" id="simulateReply">üîß Simulovat odpovƒõƒè ≈°koly</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --------------------------
    // Jednoduch√Ω stav prototypu
    // --------------------------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const screens = ["intro","age","what","where","privacy","describe","receipt","mailbox"];
    let state = {
      age: null,
      what: null,
      where: null,
      when: "",
      anon: "yes",
      name: "",
      teacher: "",
      desc: "",
      audioBlob: null,
      code: null,
    };

    function show(id) {
      screens.forEach(s => $("#screen-"+s).classList.toggle("hidden", s!==id));
      window.scrollTo({ top: 0, behavior: "instant" });
    }

    // Intro
    $("#startBtn").addEventListener("click", () => show("age"));

    // Age selection
    $$("#screen-age .choice").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.age = btn.dataset.age;
        buildWhatForAge(state.age);
        show("what");
      });
    });

    // WHAT (dynamic by age)
    const WHAT_MAP = {
      "1-3": [
        {id:"me", label:"J√°", say:"Ubli≈æuj√≠ mnƒõ", emoji:"üëä"},
        {id:"other", label:"Kamar√°d", say:"Ubli≈æuj√≠ nƒõkomu jin√©mu", emoji:"üßç‚û°Ô∏èüßç"},
        {id:"online", label:"Online", say:"Dƒõje se to online", emoji:"üì±"},
        {id:"teasing", label:"Smƒõj√≠ se", say:"Posm√≠vaj√≠ se nebo vyhazuj√≠ ze hry", emoji:"üôÖ‚Äç‚ôÇÔ∏è"},
        {id:"other-type", label:"Jin√©", say:"Nƒõco jin√©ho", emoji:"‚ùì"},
      ],
      "4-6": [
        {id:"me", label:"Ubli≈æuj√≠ mi", emoji:"üëä"},
        {id:"other", label:"Ubli≈æuj√≠ nƒõkomu jin√©mu", emoji:"üßç‚û°Ô∏èüßç"},
        {id:"online", label:"≈†ikana online", emoji:"üì±"},
        {id:"teasing", label:"Posm√≠v√°n√≠ / vyluƒçov√°n√≠", emoji:"üôÖ‚Äç‚ôÇÔ∏è"},
        {id:"other-type", label:"Jin√©", emoji:"‚ùì"},
      ],
      "7-9": [
        {id:"me", label:"Jsem obƒõt√≠ ≈°ikany"},
        {id:"other", label:"Jsem svƒõdek ≈°ikany"},
        {id:"online", label:"Kyber≈°ikana"},
        {id:"teasing", label:"Posm√≠v√°n√≠ / vyluƒçov√°n√≠"},
        {id:"other-type", label:"Jin√©"},
      ],
    };

    function buildWhatForAge(age){
      const grid = $("#whatGrid");
      grid.innerHTML = "";
      const items = WHAT_MAP[age] || WHAT_MAP["4-6"];
      items.forEach(i=>{
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.dataset.value = i.id;
        btn.innerHTML = (i.emoji? i.emoji+" " : "") + `<strong>${i.label}</strong>`;
        btn.addEventListener("click", ()=>{
          state.what = i.id;
          $$("#whatGrid .choice").forEach(b=>b.style.borderColor="#e8e8ef");
          btn.style.borderColor = "#111";
          $("#toWhere").disabled = false;
        });
        grid.appendChild(btn);
      });
      // TTS for smallest
      $("#ttsWhat").onclick = ()=> {
        const text = (age==="1-3") ? "Vyber obr√°zek: J√°, Kamar√°d, Online, Smƒõj√≠ se, nebo Jin√©." : "Vyber, co se stalo.";
        speak(text);
      };
    }

    $("#toWhere").addEventListener("click", ()=>{
      buildWhereForAge(state.age);
      show("where");
    });

    // WHERE
    const WHERE_ITEMS = [
      {id:"trida", label1:"T≈ô√≠da", say:"Ve t≈ô√≠dƒõ", emoji:"üè´"},
      {id:"chodba", label1:"Chodba", say:"Na chodbƒõ", emoji:"üö™"},
      {id:"venku", label1:"Venku", say:"Venku", emoji:"üå≥"},
      {id:"internet", label1:"Internet", say:"Na internetu", emoji:"üì±"},
      {id:"jinde", label1:"Jinde", say:"Jinde", emoji:"‚ùì"},
    ];

    function buildWhereForAge(age){
      const grid = $("#whereGrid");
      grid.innerHTML = "";
      WHERE_ITEMS.forEach(i=>{
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.dataset.value = i.id;
        btn.innerHTML = (age==="1-3" ? `${i.emoji} <strong>${i.label1}</strong>` : `<strong>${i.say}</strong>`);
        btn.addEventListener("click", ()=>{
          state.where = i.id;
          $$("#whereGrid .choice").forEach(b=>b.style.borderColor="#e8e8ef");
          btn.style.borderColor = "#111";
          $("#toPrivacy").disabled = false;
        });
        grid.appendChild(btn);
      });
      $("#ttsWhere").onclick = ()=> {
        const text = (age==="1-3") ? "Vyber obr√°zek: T≈ô√≠da, Chodba, Venku, Internet, nebo Jinde." : "Vyber, kde to bylo.";
        speak(text);
      };
    }

    $("#when").addEventListener("change", e=> state.when = e.target.value);

    // PRIVACY
    $$("#screen-privacy .choice").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const val = btn.dataset.anon;
        state.anon = val;
        $("#nameBox").classList.toggle("hidden", val!=="no");
        $$("#screen-privacy .choice").forEach(b=>b.style.borderColor="#e8e8ef");
        btn.style.borderColor = "#111";
      });
    });

    // Teachers (edit list here)
    const TEACHERS = [
      { id:"t1", name:"Mgr. Nov√°kov√° ‚Äì t≈ô√≠dn√≠ 5.B", email:"novakova@skola.cz" },
      { id:"t2", name:"Mgr. Dvo≈ô√°k ‚Äì dƒõjepis", email:"dvorak@skola.cz" },
      { id:"t3", name:"Mgr. Jel√≠nkov√° ‚Äì v√Ωchovn√° poradkynƒõ", email:"vp@skola.cz" },
    ];
    const teacherSelect = $("#teacher");
    TEACHERS.forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t.id; opt.textContent = t.name;
      teacherSelect.appendChild(opt);
    });
    teacherSelect.addEventListener("change", e=> state.teacher = e.target.value);
    $("#name").addEventListener("input", e=> state.name = e.target.value.trim());
    $("#toDescribe").addEventListener("click", ()=> show("describe"));

    // DESCRIBE
    $("#desc").addEventListener("input", e=> state.desc = e.target.value);

    // Audio
