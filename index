<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bezpečná schránka – prototyp</title>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #111;
      --muted: #555;
      --primary: #ff3131;
      --primary-press: #e12828;
      --ok: #0a7f3f;
      --focus: 3px solid #3b82f6;
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--text); background: var(--bg);
      display: grid; place-items: center;
    }
    .app {
      width: min(440px, 100%);
      min-height: 100dvh;
      background: var(--bg);
    }
    header {
      padding: 16px 20px; text-align: center;
      color: var(--muted); font-size: 14px;
    }
    main { padding: 20px; }
    .card {
      background: var(--card); border-radius: var(--radius);
      padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,.06);
    }
    .big-red {
      display: block; width: 100%; padding: 22px 16px; border: 0;
      background: var(--primary); color: #fff; font-size: 22px; font-weight: 700;
      border-radius: 20px; cursor: pointer;
    }
    .big-red:active { background: var(--primary-press); }
    .row { display: grid; gap: 12px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .btn, .choice {
      background: var(--card); border: 2px solid #e8e8ef; border-radius: 14px;
      padding: 14px; text-align: center; cursor: pointer;
      font-size: 16px;
    }
    .choice strong { display: block; margin-top: 6px; }
    .btn:focus, .choice:focus, .big-red:focus, input[type="text"]:focus, textarea:focus, select:focus { outline: var(--focus); }
    .muted { color: var(--muted); font-size: 14px; }
    .actions { display: flex; gap: 10px; justify-content: space-between; margin-top: 16px; }
    .next { background: #111; color: #fff; border: 0; border-radius: 12px; padding: 14px 16px; width: 100%; font-size: 16px; }
    .ghost { background: transparent; border: 2px solid #ddd; color: #111; border-radius: 12px; padding: 12px 16px; width: 100%; font-size: 16px; }
    label { display: block; margin: 10px 0 6px; font-weight: 600; }
    input[type="text"], select, textarea {
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 2px solid #e8e8ef; background: #fff; font-size: 16px;
    }
    textarea { min-height: 120px; resize: vertical; }
    .hidden { display: none !important; }
    .status {
      display: inline-block; background: #eef7f1; color: var(--ok);
      padding: 6px 10px; border-radius: 999px; font-weight: 600; font-size: 14px;
    }
    .tts { margin-left: 6px; font-size: 15px; background: #f1f5ff; border: 0; border-radius: 999px; padding: 6px 10px; cursor: pointer; }
    .audioBox {
      border: 2px dashed #e0e0ea; border-radius: 16px; padding: 16px; text-align: center;
    }
    .audioBox button { margin: 0 6px 8px 6px; padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .small { font-size: 13px; color: var(--muted); }
    .center { text-align:center; }
  </style>
</head>
<body>
  <div class="app">
    <header>Bezpečná schránka – <span class="muted">prototyp (offline, pouze do vašeho prohlížeče)</span></header>
    <main>
      <!-- SCREEN: Intro -->
      <section id="screen-intro" class="card">
        <div class="row" style="gap:16px;">
          <button class="big-red" id="startBtn">Chci něco nahlásit</button>
          <div class="muted center">ℹ️ Krátké vysvětlení najdeš v „Jak to funguje?“ (přidáme v plné verzi).</div>
        </div>
      </section>

      <!-- SCREEN: Age -->
      <section id="screen-age" class="card hidden">
        <h2 style="margin-top:0;">Vyber, do které třídy chodíš</h2>
        <div class="grid-3">
          <button class="choice" data-age="1-3">👶<strong>1.–3.</strong></button>
          <button class="choice" data-age="4-6">🧒<strong>4.–6.</strong></button>
          <button class="choice" data-age="7-9">🧑<strong>7.–9.</strong></button>
        </div>
        <div class="actions">
          <button class="ghost" data-back="intro">Zpět</button>
        </div>
      </section>

      <!-- SCREEN: What happened -->
      <section id="screen-what" class="card hidden">
        <div class="row">
          <div style="display:flex;align-items:center;gap:8px;">
            <h2 id="whatTitle" style="margin:0;">Co se stalo?</h2>
            <button class="tts" id="ttsWhat" title="Přečíst nahlas">🔊</button>
          </div>
          <div id="whatGrid" class="grid-2">
            <!-- buttons injected based on age -->
          </div>
          <div class="actions">
            <button class="ghost" data-back="age">Zpět</button>
            <button class="next" id="toWhere" disabled>Pokračovat</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Where -->
      <section id="screen-where" class="card hidden">
        <div class="row">
          <div style="display:flex;align-items:center;gap:8px;">
            <h2 id="whereTitle" style="margin:0;">Kde to bylo?</h2>
            <button class="tts" id="ttsWhere" title="Přečíst nahlas">🔊</button>
          </div>
          <div class="grid-2" id="whereGrid"></div>
          <label for="when">Kdy zhruba?</label>
          <select id="when">
            <option value="">Vyber…</option>
            <option value="dnes">Dnes</option>
            <option value="vcera">Včera</option>
            <option value="drive">Dřív</option>
          </select>
          <div class="actions">
            <button class="ghost" data-back="what">Zpět</button>
            <button class="next" id="toPrivacy" disabled>Pokračovat</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Privacy / Name / Teacher -->
      <section id="screen-privacy" class="card hidden">
        <div class="row">
          <h2 style="margin:0;">Chceš zůstat anonymní?</h2>
          <div class="grid-2">
            <button class="choice" data-anon="yes">🎭 <strong>Zůstat anonymně</strong></button>
            <button class="choice" data-anon="no">✍️ <strong>Napíšu své jméno</strong></button>
          </div>
          <div id="nameBox" class="hidden">
            <label for="name">Jméno (nepovinné)</label>
            <input id="name" type="text" placeholder="např. Aneta, 6.B" autocomplete="name">
          </div>

          <label style="margin-top:12px;">Chceš, aby to dostal i učitel, kterému důvěřuješ?</label>
          <select id="teacher">
            <option value="">Ne, jen psycholog / VP</option>
          </select>

          <div class="actions">
            <button class="ghost" data-back="where">Zpět</button>
            <button class="next" id="toDescribe">Pokračovat</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Describe / Audio -->
      <section id="screen-describe" class="card hidden">
        <div class="row">
          <h2 style="margin:0;">Popiš, co se stalo</h2>
          <p class="small">Můžeš to <strong>napsat</strong> nebo <strong>namluvit</strong>. Stačí krátce.</p>
          <label for="desc">Text (nepovinné)</label>
          <textarea id="desc" placeholder="Např.: Na chodbě mi spolužák strhává čepici a směje se."></textarea>

          <div class="audioBox">
            <div id="aState" class="small">🎤 Hlasová zpráva (max. ~2 min)</div>
            <div style="margin-top:8px;">
              <button id="recBtn">Nahrát</button>
              <button id="stopBtn" disabled>Zastavit</button>
              <button id="playBtn" disabled>Přehrát</button>
              <audio id="player" controls class="hidden"></audio>
            </div>
            <div class="small">Pozn.: v prototypu se zvuk neukládá trvale (po obnovení stránky zmizí).</div>
          </div>

          <div class="actions">
            <button class="ghost" data-back="privacy">Zpět</button>
            <button class="next" id="submitBtn">Odeslat</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Receipt -->
      <section id="screen-receipt" class="card hidden">
        <div class="row center">
          <h2>Díky, že ses svěřil/a 💛</h2>
          <p>Tvoje zpráva k nám dorazila. Ozveme se sem, do tvé schránky.</p>
          <div class="status">Tvůj kód: <span id="caseCode" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace;"></span></div>
          <div class="actions" style="margin-top:16px;">
            <button class="next" id="copyCode">📋 Uložit kód</button>
            <button class="ghost" id="gotoMailbox">Otevřít schránku</button>
          </div>
        </div>
      </section>

      <!-- SCREEN: Mailbox -->
      <section id="screen-mailbox" class="card hidden">
        <div class="row">
          <h2>Moje schránka</h2>
          <div id="mailboxContent" class="row"></div>
          <div class="actions">
            <button class="ghost" data-back="intro">Domů</button>
          </div>
          <p class="small muted">Pozn.: V této ukázce odpovědi školy simulujeme – v reálné aplikaci je píše psycholog.</p>
          <div class="actions">
            <button class="btn" id="simulateReply">🔧 Simulovat odpověď školy</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --------------------------
    // Jednoduchý stav prototypu
    // --------------------------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const screens = ["intro","age","what","where","privacy","describe","receipt","mailbox"];
    let state = {
      age: null,
      what: null,
      where: null,
      when: "",
      anon: "yes",
      name: "",
      teacher: "",
      desc: "",
      audioBlob: null,
      code: null,
    };

    function show(id) {
      screens.forEach(s => $("#screen-"+s).classList.toggle("hidden", s!==id));
      window.scrollTo({ top: 0, behavior: "instant" });
    }

    // Intro
    $("#startBtn").addEventListener("click", () => show("age"));

    // Age selection
    $$("#screen-age .choice").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.age = btn.dataset.age;
        buildWhatForAge(state.age);
        show("what");
      });
    });

    // WHAT (dynamic by age)
    const WHAT_MAP = {
      "1-3": [
        {id:"me", label:"Já", say:"Ubližují mně", emoji:"👊"},
        {id:"other", label:"Kamarád", say:"Ubližují někomu jinému", emoji:"🧍➡️🧍"},
        {id:"online", label:"Online", say:"Děje se to online", emoji:"📱"},
        {id:"teasing", label:"Smějí se", say:"Posmívají se nebo vyhazují ze hry", emoji:"🙅‍♂️"},
        {id:"other-type", label:"Jiné", say:"Něco jiného", emoji:"❓"},
      ],
      "4-6": [
        {id:"me", label:"Ubližují mi", emoji:"👊"},
        {id:"other", label:"Ubližují někomu jinému", emoji:"🧍➡️🧍"},
        {id:"online", label:"Šikana online", emoji:"📱"},
        {id:"teasing", label:"Posmívání / vylučování", emoji:"🙅‍♂️"},
        {id:"other-type", label:"Jiné", emoji:"❓"},
      ],
      "7-9": [
        {id:"me", label:"Jsem obětí šikany"},
        {id:"other", label:"Jsem svědek šikany"},
        {id:"online", label:"Kyberšikana"},
        {id:"teasing", label:"Posmívání / vylučování"},
        {id:"other-type", label:"Jiné"},
      ],
    };

    function buildWhatForAge(age){
      const grid = $("#whatGrid");
      grid.innerHTML = "";
      const items = WHAT_MAP[age] || WHAT_MAP["4-6"];
      items.forEach(i=>{
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.dataset.value = i.id;
        btn.innerHTML = (i.emoji? i.emoji+" " : "") + `<strong>${i.label}</strong>`;
        btn.addEventListener("click", ()=>{
          state.what = i.id;
          $$("#whatGrid .choice").forEach(b=>b.style.borderColor="#e8e8ef");
          btn.style.borderColor = "#111";
          $("#toWhere").disabled = false;
        });
        grid.appendChild(btn);
      });
      // TTS for smallest
      $("#ttsWhat").onclick = ()=> {
        const text = (age==="1-3") ? "Vyber obrázek: Já, Kamarád, Online, Smějí se, nebo Jiné." : "Vyber, co se stalo.";
        speak(text);
      };
    }

    $("#toWhere").addEventListener("click", ()=>{
      buildWhereForAge(state.age);
      show("where");
    });

    // WHERE
    const WHERE_ITEMS = [
      {id:"trida", label1:"Třída", say:"Ve třídě", emoji:"🏫"},
      {id:"chodba", label1:"Chodba", say:"Na chodbě", emoji:"🚪"},
      {id:"venku", label1:"Venku", say:"Venku", emoji:"🌳"},
      {id:"internet", label1:"Internet", say:"Na internetu", emoji:"📱"},
      {id:"jinde", label1:"Jinde", say:"Jinde", emoji:"❓"},
    ];

    function buildWhereForAge(age){
      const grid = $("#whereGrid");
      grid.innerHTML = "";
      WHERE_ITEMS.forEach(i=>{
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.dataset.value = i.id;
        btn.innerHTML = (age==="1-3" ? `${i.emoji} <strong>${i.label1}</strong>` : `<strong>${i.say}</strong>`);
        btn.addEventListener("click", ()=>{
          state.where = i.id;
          $$("#whereGrid .choice").forEach(b=>b.style.borderColor="#e8e8ef");
          btn.style.borderColor = "#111";
          $("#toPrivacy").disabled = false;
        });
        grid.appendChild(btn);
      });
      $("#ttsWhere").onclick = ()=> {
        const text = (age==="1-3") ? "Vyber obrázek: Třída, Chodba, Venku, Internet, nebo Jinde." : "Vyber, kde to bylo.";
        speak(text);
      };
    }

    $("#when").addEventListener("change", e=> state.when = e.target.value);

    // PRIVACY
    $$("#screen-privacy .choice").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const val = btn.dataset.anon;
        state.anon = val;
        $("#nameBox").classList.toggle("hidden", val!=="no");
        $$("#screen-privacy .choice").forEach(b=>b.style.borderColor="#e8e8ef");
        btn.style.borderColor = "#111";
      });
    });

    // Teachers (edit list here)
    const TEACHERS = [
      { id:"t1", name:"Mgr. Nováková – třídní 5.B", email:"novakova@skola.cz" },
      { id:"t2", name:"Mgr. Dvořák – dějepis", email:"dvorak@skola.cz" },
      { id:"t3", name:"Mgr. Jelínková – výchovná poradkyně", email:"vp@skola.cz" },
    ];
    const teacherSelect = $("#teacher");
    TEACHERS.forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t.id; opt.textContent = t.name;
      teacherSelect.appendChild(opt);
    });
    teacherSelect.addEventListener("change", e=> state.teacher = e.target.value);
    $("#name").addEventListener("input", e=> state.name = e.target.value.trim());
    $("#toDescribe").addEventListener("click", ()=> show("describe"));

    // DESCRIBE
    $("#desc").addEventListener("input", e=> state.desc = e.target.value);

    // Audio
